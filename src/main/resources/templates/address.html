<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
 <title> üçΩÔ∏è Spark Cloud Kitchen</title>
     <link rel="icon" type="image/png" href="/images/spark.png">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Bootstrap -->
<link rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

<style>
    body {
        background: #f5f6f8;
    }
    #map {
        height: 360px;
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }
</style>
</head>

<body>

<!-- NAVBAR -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-4">

    <a th:href="@{/cart}" class="btn btn-outline-dark btn-sm mb-3">
        ‚Üê Back to Cart
    </a>

    <h4 class="mb-3">üìç Select Delivery Location</h4>

    <div class="row">

        <!-- MAP -->
        <div class="col-md-7 mb-4">

            <input id="searchBox"
                   class="form-control mb-2"
                   placeholder="Search area, street, landmark">

            <div id="map"></div>
        </div>

        <!-- ADDRESS FORM -->
        <div class="col-md-5">
            <form th:action="@{/address/save}" method="post">

                <!-- Hidden -->
                <input type="hidden" id="lat" name="latitude">
                <input type="hidden" id="lng" name="longitude">
                <input type="hidden" id="fullAddress" name="fullAddress">

                <div class="form-group">
                    <label>House / Flat No</label>
                    <input class="form-control" name="house" required>
                </div>

                <div class="form-group">
                    <label>Area / Street</label>
                    <input class="form-control" id="area" name="area" required>
                </div>

                <div class="form-group">
                    <label>Landmark</label>
                    <input class="form-control" name="landmark">
                </div>

                <div class="form-group">
                    <label>City</label>
                    <input class="form-control" id="city" name="city" required>
                </div>

                <div class="form-group">
                    <label>Pincode</label>
                    <input class="form-control" id="pincode" name="pincode" required>
                </div>

                <button class="btn btn-success btn-block mt-3">
                    Save Address & Continue
                </button>
            </form>
        </div>
  <a th:href="@{/}" class="btn btn-secondary mt-2 w-10">
    ‚Üê Back to Home
</a>
    </div>
</div>

<!-- GOOGLE MAP LOGIC -->
<script>
let map, marker, geocoder;

function initMap() {

    geocoder = new google.maps.Geocoder();

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => loadMap(pos.coords.latitude, pos.coords.longitude),
            () => loadMap(17.3850, 78.4867) // Hyderabad fallback
        );
    } else {
        loadMap(17.3850, 78.4867);
    }
}

function loadMap(lat, lng) {

    const location = { lat: lat, lng: lng };

    map = new google.maps.Map(document.getElementById("map"), {
        center: location,
        zoom: 15
    });

    marker = new google.maps.Marker({
        position: location,
        map: map,
        draggable: true
    });

    updateLatLng(lat, lng);
    reverseGeocode(lat, lng);

    marker.addListener("dragend", () => {
        const pos = marker.getPosition();
        updateLatLng(pos.lat(), pos.lng());
        reverseGeocode(pos.lat(), pos.lng());
    });

    map.addListener("click", e => {
        marker.setPosition(e.latLng);
        updateLatLng(e.latLng.lat(), e.latLng.lng());
        reverseGeocode(e.latLng.lat(), e.latLng.lng());
    });

    const input = document.getElementById("searchBox");
    const autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.bindTo("bounds", map);

    autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        map.panTo(place.geometry.location);
        marker.setPosition(place.geometry.location);

        updateLatLng(
            place.geometry.location.lat(),
            place.geometry.location.lng()
        );

        reverseGeocode(
            place.geometry.location.lat(),
            place.geometry.location.lng()
        );
    });
}

function updateLatLng(lat, lng) {
    document.getElementById("lat").value = lat;
    document.getElementById("lng").value = lng;
}

function reverseGeocode(lat, lng) {

    geocoder.geocode({ location: { lat, lng } }, (results, status) => {

        if (status === "OK" && results[0]) {

            document.getElementById("fullAddress").value =
                results[0].formatted_address;

            const components = results[0].address_components;

            components.forEach(c => {
                if (c.types.includes("route") || c.types.includes("sublocality")) {
                    document.getElementById("area").value = c.long_name;
                }
                if (c.types.includes("locality")) {
                    document.getElementById("city").value = c.long_name;
                }
                if (c.types.includes("postal_code")) {
                    document.getElementById("pincode").value = c.long_name;
                }
            });
        }
    });
}
</script>

<!-- GOOGLE MAP API -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-wGWUkj4rWaRVYoCATpUAwZubYjD9JzQ&libraries=places&callback=initMap"
  async defer>
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>